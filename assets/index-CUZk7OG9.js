(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const Z=e=>{e.classList.toggle("card__like-button_is-active")},K=e=>{e.remove()},G=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),U=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:r},n)=>{const s=G(),l=s.querySelector(".card__like-button"),u=s.querySelector(".card__control-button_type_delete"),p=s.querySelector(".card__image");p.src=e.image,p.alt=e.name,s.querySelector(".card__title").textContent=e.name;const i=Array.isArray(e.likes)?e.likes.length:0,c=s.querySelector(".card__like-count");return c&&(c.textContent=i),Array.isArray(e.likes)&&e.likes.some(v=>v._id===n)&&l.classList.add("card__like-button_is-active"),e.ownerId!==n?u.remove():r&&u.addEventListener("click",()=>r(s,e.id)),o&&l.addEventListener("click",()=>o(l)),t&&p.addEventListener("click",()=>t({name:e.name,link:e.image})),s},O=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");_(t)}},f=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",O)},_=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",O)},Q=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{_(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&_(e)})},a={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"80bb5d09-0741-41cb-961e-7195d1f713c1","Content-Type":"application/json"}},d=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),X=()=>fetch(`${a.baseUrl}/users/me`,{headers:a.headers}).then(d),N=()=>fetch(`${a.baseUrl}/cards`,{headers:a.headers}).then(d),Y=({name:e,about:t})=>fetch(`${a.baseUrl}/users/me`,{method:"PATCH",headers:a.headers,body:JSON.stringify({name:e,about:t})}).then(d),D=({avatar:e})=>fetch(`${a.baseUrl}/users/me/avatar`,{method:"PATCH",headers:a.headers,body:JSON.stringify({avatar:e})}).then(d),ee=({name:e,link:t})=>fetch(`${a.baseUrl}/cards`,{method:"POST",headers:a.headers,body:JSON.stringify({name:e,link:t})}).then(d),te=e=>fetch(`${a.baseUrl}/cards/${e}`,{method:"DELETE",headers:a.headers}).then(d),oe=(e,t)=>fetch(`${a.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:a.headers}).then(d);function w(e,t,o,r){const n=e.querySelector(`#${t.id}-error`);t.classList.add(r.inputErrorClass),n.textContent=o,n.classList.add(r.errorClass)}function re(e,t,o){const r=e.querySelector(`#${t.id}-error`);t.classList.remove(o.inputErrorClass),r.textContent="",r.classList.remove(o.errorClass)}function ne(e,t,o){return t.dataset.errorMessage&&!/^[A-Za-zА-Яа-яЁё\-\s]+$/.test(t.value)?(w(e,t,t.dataset.errorMessage,o),!1):t.validity.valid?(re(e,t,o),!0):(w(e,t,t.validationMessage,o),!1)}function se(e){return e.some(t=>{if(t.dataset.errorMessage){const o=/^[A-Za-zА-Яа-яЁё\s\-]*$/;if(t.value&&!o.test(t.value))return!0}return!t.validity.valid})}function ce(e,t){e.classList.add(t.inactiveButtonClass),e.disabled=!0}function le(e,t){e.classList.remove(t.inactiveButtonClass),e.disabled=!1}function P(e,t,o){se(e)?ce(t,o):le(t,o)}function ie(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);P(o,r,t),o.forEach(n=>{n.addEventListener("input",()=>{ne(e,n,t),P(o,r,t)})})}function ae(e){Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{ie(o,e)})}let T;const W=document.querySelector(".places__list"),q=document.querySelector(".popup_type_edit"),y=q.querySelector(".popup__form"),z=y.querySelector(".popup__input_type_name"),H=y.querySelector(".popup__input_type_description"),E=document.querySelector(".popup_type_new-card"),h=E.querySelector(".popup__form"),ue=h.querySelector(".popup__input_type_card-name"),de=h.querySelector(".popup__input_type_url"),x=document.querySelector(".popup_type_image"),B=x.querySelector(".popup__image"),pe=x.querySelector(".popup__caption"),_e=document.querySelector(".profile__edit-button"),me=document.querySelector(".profile__add-button"),M=document.querySelector(".profile__title"),I=document.querySelector(".profile__description"),j=document.querySelector(".profile__image"),A=document.querySelector(".popup_type_edit-avatar"),C=A.querySelector(".popup__form"),fe=C.querySelector(".popup__input"),m=document.querySelector(".popup_type_info"),S=m?.querySelector(".popup__title"),g=m?.querySelector(".popup__info"),J=m?.querySelector(".popup__text"),k=m?.querySelector(".popup__list"),$=document.querySelector(".header__logo")||document.querySelector(".logo"),R=({name:e,link:t})=>{B.src=t,B.alt=e,pe.textContent=e,f(x)},ye=()=>{if(!m||!S||!g||!J||!k){console.error("Элементы модального окна не найдены");return}g.innerHTML="",k.innerHTML="",S.textContent="Загрузка...",f(m),N().then(e=>{F(e)}).catch(e=>{console.log("Ошибка загрузки данных:",e),F([{name:"Океан",likes:[{_id:"1"},{_id:"2"}],owner:{_id:"1",name:"Жак-Ив Кусто"}},{name:"Горы",likes:[{_id:"1"}],owner:{_id:"2",name:"Альпинист"}},{name:"Лес",likes:[],owner:{_id:"3",name:"Лесник"}}])})},F=e=>{const t=e.reduce((i,c)=>i+c.likes.length,0),o=new Map,r=new Map;e.forEach(i=>{i.likes.forEach(c=>{o.has(c._id)||(o.set(c._id,0),r.set(c._id,c)),o.set(c._id,o.get(c._id)+1)})});const n=o.size;let s=0,l=null;o.forEach((i,c)=>{i>s&&(s=i,l=r.get(c))});const u=[...e].sort((i,c)=>c.likes.length-i.likes.length).slice(0,3);S.textContent="Статистика карточек",[{label:"Всего пользователей:",value:n},{label:"Всего лайков:",value:t},{label:"Максимально лайков от одного:",value:s},{label:"Чемпион лайков:",value:l?l.name:"Нет данных"}].forEach(({label:i,value:c})=>{const L=document.createElement("dt");L.textContent=i;const v=document.createElement("dd");v.textContent=c;const b=document.createElement("div");b.classList.add("popup__info-item"),b.appendChild(L),b.appendChild(v),g.appendChild(b)}),J.textContent="Популярные карточки:",u.forEach(i=>{const c=document.createElement("span");c.classList.add("popup__list-item","popup__list-item_type_badge"),c.textContent=i.name,k.appendChild(c)})},he=e=>{e.preventDefault();const t=y.querySelector(".popup__button"),o=t.textContent;t.textContent="Сохранение...",t.disabled=!0,Y({name:z.value,about:H.value}).then(r=>{M.textContent=r.name,I.textContent=r.about,_(q)}).catch(r=>{console.log(r)}).finally(()=>{t.textContent=o,t.disabled=!1})},V=e=>{j.style.backgroundImage=`url(${e})`},ve=e=>{e.preventDefault();const t=C.querySelector(".popup__button"),o=t.textContent;t.disabled=!0,t.textContent="Сохранение...",D({avatar:fe.value}).then(r=>{V(r.avatar),_(A)}).catch(r=>{console.log(r)}).finally(()=>{t.textContent=o,t.disabled=!1})},be=e=>{e.preventDefault();const t=y.querySelector(".popup__button"),o=t.textContent;t.textContent="Сохранение...",t.disabled=!0,ee({name:ue.value,link:de.value}).then(r=>{const n=U({name:r.name,link:r.link},{onPreviewPicture:R,onLikeIcon:Z,onDeleteCard:K});W.prepend(n),_(E),h.reset()}).catch(r=>{console.log(r)}).finally(()=>{t.textContent=o,t.disabled=!1})};y.addEventListener("submit",he);h.addEventListener("submit",be);C.addEventListener("submit",ve);_e.addEventListener("click",()=>{z.value=M.textContent,H.value=I.textContent,f(q)});j.addEventListener("click",()=>{C.reset(),f(A)});me.addEventListener("click",()=>{h.reset(),f(E)});$?$.addEventListener("click",ye):console.error("Элемент логотипа не найден");const Ce=document.querySelectorAll(".popup");Ce.forEach(e=>{Q(e)});const Le={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};ae(Le);Promise.all([N(),X()]).then(([e,t])=>{M.textContent=t.name,I.textContent=t.about,V(t.avatar),T=t._id,e.forEach(o=>{const r=U({name:o.name,image:o.link,id:o._id,ownerId:o.owner._id,likes:o.likes},{onPreviewPicture:R,onLikeIcon:n=>{const s=n.classList.contains("card__like-button_is-active");oe(o._id,s).then(l=>{n.classList.toggle("card__like-button_is-active",!s);const u=n.closest(".card__description")?.querySelector(".card__like-count");if(u){const p=Array.isArray(l.likes)?l.likes.length:0;u.textContent=p}}).catch(l=>{console.log(l)})},onDeleteCard:(n,s)=>{te(s).then(()=>n.remove()).catch(l=>{console.log(l)})}},T);W.appendChild(r)})}).catch(e=>{console.log(e)});
