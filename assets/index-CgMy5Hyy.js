(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const X=e=>{e.classList.toggle("card__like-button_is-active")},Y=e=>{e.remove()},D=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),U=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:r},n)=>{const s=D(),l=s.querySelector(".card__like-button"),u=s.querySelector(".card__control-button_type_delete"),p=s.querySelector(".card__image");p.src=e.image,p.alt=e.name,s.querySelector(".card__title").textContent=e.name;const i=Array.isArray(e.likes)?e.likes.length:0,c=s.querySelector(".card__like-count");return c&&(c.textContent=i),Array.isArray(e.likes)&&e.likes.some(b=>b._id===n)&&l.classList.add("card__like-button_is-active"),e.ownerId!==n?u.remove():r&&u.addEventListener("click",()=>r(s,e.id)),o&&l.addEventListener("click",()=>o(l)),t&&p.addEventListener("click",()=>t({name:e.name,link:e.image})),s},O=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");_(t)}},y=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",O)},_=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",O)},ee=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{_(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&_(e)})},a={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"80bb5d09-0741-41cb-961e-7195d1f713c1","Content-Type":"application/json"}},d=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),te=()=>fetch(`${a.baseUrl}/users/me`,{headers:a.headers}).then(d),N=()=>fetch(`${a.baseUrl}/cards`,{headers:a.headers}).then(d),oe=({name:e,about:t})=>fetch(`${a.baseUrl}/users/me`,{method:"PATCH",headers:a.headers,body:JSON.stringify({name:e,about:t})}).then(d),re=({avatar:e})=>fetch(`${a.baseUrl}/users/me/avatar`,{method:"PATCH",headers:a.headers,body:JSON.stringify({avatar:e})}).then(d),ne=({name:e,link:t})=>fetch(`${a.baseUrl}/cards`,{method:"POST",headers:a.headers,body:JSON.stringify({name:e,link:t})}).then(d),se=e=>fetch(`${a.baseUrl}/cards/${e}`,{method:"DELETE",headers:a.headers}).then(d),ce=(e,t)=>fetch(`${a.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:a.headers}).then(d);function B(e,t,o,r){const n=e.querySelector(`#${t.id}-error`);t.classList.add(r.inputErrorClass),n.textContent=o,n.classList.add(r.errorClass)}function W(e,t,o){const r=e.querySelector(`#${t.id}-error`);t.classList.remove(o.inputErrorClass),r.textContent="",r.classList.remove(o.errorClass)}function le(e,t,o){return t.dataset.errorMessage&&!/^[A-Za-zА-Яа-яЁё\-\s]+$/.test(t.value)?(B(e,t,t.dataset.errorMessage,o),!1):t.validity.valid?(W(e,t,o),!0):(B(e,t,t.validationMessage,o),!1)}function ie(e){return e.some(t=>{if(t.dataset.errorMessage){const o=/^[A-Za-zА-Яа-яЁё\s\-]*$/;if(t.value&&!o.test(t.value))return!0}return!t.validity.valid})}function z(e,t){e.classList.add(t.inactiveButtonClass),e.disabled=!0}function ae(e,t){e.classList.remove(t.inactiveButtonClass),e.disabled=!1}function T(e,t,o){ie(e)?z(t,o):ae(t,o)}function ue(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);T(o,r,t),o.forEach(n=>{n.addEventListener("input",()=>{le(e,n,t),T(o,r,t)})})}function H(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);o.forEach(n=>{W(e,n,t)}),z(r,t)}function de(e){Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{ue(o,e)})}let w;const j=document.querySelector(".places__list"),k=document.querySelector(".popup_type_edit"),m=k.querySelector(".popup__form"),J=m.querySelector(".popup__input_type_name"),R=m.querySelector(".popup__input_type_description"),E=document.querySelector(".popup_type_new-card"),h=E.querySelector(".popup__form"),pe=h.querySelector(".popup__input_type_card-name"),_e=h.querySelector(".popup__input_type_url"),x=document.querySelector(".popup_type_image"),F=x.querySelector(".popup__image"),fe=x.querySelector(".popup__caption"),me=document.querySelector(".profile__edit-button"),ye=document.querySelector(".profile__add-button"),A=document.querySelector(".profile__title"),M=document.querySelector(".profile__description"),V=document.querySelector(".profile__image"),I=document.querySelector(".popup_type_edit-avatar"),C=I.querySelector(".popup__form"),he=C.querySelector(".popup__input"),f=document.querySelector(".popup_type_info"),L=f?.querySelector(".popup__title"),g=f?.querySelector(".popup__info"),Z=f?.querySelector(".popup__text"),q=f?.querySelector(".popup__list"),K=e=>{e.querySelectorAll(".popup__input").forEach(r=>r.value=""),e.querySelectorAll(".popup__error").forEach(r=>r.textContent=""),H(e,P)},$=document.querySelector(".header__logo")||document.querySelector(".logo"),G=({name:e,link:t})=>{F.src=t,F.alt=e,fe.textContent=e,y(x)},be=()=>{if(!f||!L||!g||!Z||!q){console.log("ощибка");return}g.innerHTML="",q.innerHTML="",L.textContent="Загрузка...",y(f),N().then(e=>{ve(e)}).catch(e=>{console.log(e)})},ve=e=>{const t=e.reduce((i,c)=>i+c.likes.length,0),o=new Map,r=new Map;e.forEach(i=>{i.likes.forEach(c=>{o.has(c._id)||(o.set(c._id,0),r.set(c._id,c)),o.set(c._id,o.get(c._id)+1)})});const n=o.size;let s=0,l=null;o.forEach((i,c)=>{i>s&&(s=i,l=r.get(c))});const u=[...e].sort((i,c)=>c.likes.length-i.likes.length).slice(0,3);L.textContent="Статистика карточек",[{label:"Всего пользователей:",value:n},{label:"Всего лайков:",value:t},{label:"Максимально лайков от одного:",value:s},{label:"Чемпион лайков:",value:l?l.name:"Нет данных"}].forEach(({label:i,value:c})=>{const S=document.createElement("dt");S.textContent=i;const b=document.createElement("dd");b.textContent=c;const v=document.createElement("div");v.classList.add("popup__info-item"),v.appendChild(S),v.appendChild(b),g.appendChild(v)}),Z.textContent="Популярные карточки:",u.forEach(i=>{const c=document.createElement("span");c.classList.add("popup__list-item","popup__list-item_type_badge"),c.textContent=i.name,q.appendChild(c)})},Ce=e=>{e.preventDefault();const t=m.querySelector(".popup__button"),o=t.textContent;t.textContent="Сохранение...",t.disabled=!0,oe({name:J.value,about:R.value}).then(r=>{A.textContent=r.name,M.textContent=r.about,_(k)}).catch(r=>{console.log(r)}).finally(()=>{t.textContent=o,t.disabled=!1})},Q=e=>{V.style.backgroundImage=`url(${e})`},Se=e=>{e.preventDefault();const t=C.querySelector(".popup__button"),o=t.textContent;t.disabled=!0,t.textContent="Сохранение...",re({avatar:he.value}).then(r=>{Q(r.avatar),_(I)}).catch(r=>{console.log(r)}).finally(()=>{t.textContent=o,t.disabled=!1})},Le=e=>{e.preventDefault();const t=m.querySelector(".popup__button"),o=t.textContent;t.textContent="Создание...",t.disabled=!0,ne({name:pe.value,link:_e.value}).then(r=>{const n=U({name:r.name,link:r.link},{onPreviewPicture:G,onLikeIcon:X,onDeleteCard:Y});j.prepend(n),_(E),h.reset()}).catch(r=>{console.log(r)}).finally(()=>{t.textContent=o,t.disabled=!1})};m.addEventListener("submit",Ce);h.addEventListener("submit",Le);C.addEventListener("submit",Se);me.addEventListener("click",()=>{J.value=A.textContent,R.value=M.textContent,H(m,P),y(k)});V.addEventListener("click",()=>{K(C),y(I)});ye.addEventListener("click",()=>{K(h),y(E)});$?$.addEventListener("click",be):console.error("Элемент логотипа не найден");const ge=document.querySelectorAll(".popup");ge.forEach(e=>{ee(e)});const P={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};de(P);Promise.all([N(),te()]).then(([e,t])=>{A.textContent=t.name,M.textContent=t.about,Q(t.avatar),w=t._id,e.forEach(o=>{const r=U({name:o.name,image:o.link,id:o._id,ownerId:o.owner._id,likes:o.likes},{onPreviewPicture:G,onLikeIcon:n=>{const s=n.classList.contains("card__like-button_is-active");ce(o._id,s).then(l=>{n.classList.toggle("card__like-button_is-active",!s);const u=n.closest(".card__description")?.querySelector(".card__like-count");if(u){const p=Array.isArray(l.likes)?l.likes.length:0;u.textContent=p}}).catch(l=>{console.log(l)})},onDeleteCard:(n,s)=>{se(s).then(()=>n.remove()).catch(l=>{console.log(l)})}},w);j.appendChild(r)})}).catch(e=>{console.log(e)});
